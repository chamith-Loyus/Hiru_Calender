name: Build iOS Wrapper

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          
      - name: Install dependencies
        run: |
          cd ios_wrapper
          flutter pub get
          
      - name: Build iOS (Simulator)
        run: |
          cd ios_wrapper
          flutter build ios --simulator --no-codesign
          
      - name: Build iOS (Production)
        if: github.repository == 'chamith-Loyus/Hiru_Calender'
        env:
          P12_BASE64: ${{ secrets.P12_CERTIFICATE }}
          P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
          PROVISIONING_BASE64: ${{ secrets.PROVISIONING_PROFILE }}
          TEAM_ID: "6LQK8G38G5"
        run: |
          set -x
          cd ios_wrapper
          mkdir -p ios/certs
          
          # Decode certificates
          printf '%s' "$P12_BASE64" | base64 -D -o ios/certs/certificate.p12
          printf '%s' "$PROVISIONING_BASE64" | base64 -D -o ios/certs/profile.mobileprovision
          
          # Extract UUID using macOS native tools (robust)
          UUID=$(/usr/libexec/PlistBuddy -c "Print UUID" /dev/stdin <<< $(security cms -D -i ios/certs/profile.mobileprovision))
          echo "Parsed UUID: $UUID"
          
          if [ -z "$UUID" ]; then
            echo "ERROR: Could not extract UUID from provisioning profile!"
            exit 1
          fi
          
          # Install Provisioning Profile
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp ios/certs/profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/$UUID.mobileprovision
          
          # Keychain setup
          security create-keychain -p "buildpass" build.keychain
          security list-keychains -d user -s build.keychain $(security list-keychains -d user | xargs)
          security default-keychain -s build.keychain
          security unlock-keychain -p "buildpass" build.keychain
          security set-keychain-settings -lut 21600 build.keychain
          
          # Import
          security import ios/certs/certificate.p12 -k build.keychain -P "$P12_PASSWORD" -A
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "buildpass" build.keychain
          
          # Build signed IPA
          flutter build ipa --release \
            --export-options-plist=ios/ExportOptions.plist \
            --build-name=1.0.0 --build-number=1

          
      - name: Upload to TestFlight
        if: github.repository == 'chamith-Loyus/Hiru_Calender'
        env:
          KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_KEY_CONTENT }}
        run: |
          cd ios_wrapper
          
          # Trim and validate credential lengths to catch hidden characters
          CLEAN_KEY_ID=$(echo "$KEY_ID" | xargs)
          CLEAN_ISSUER_ID=$(echo "$ISSUER_ID" | xargs)
          
          echo "Credential Validation:"
          echo "Key ID Length: ${#CLEAN_KEY_ID} (Should be 10)"
          echo "Issuer ID Length: ${#CLEAN_ISSUER_ID} (Should be 36)"
          
          mkdir -p ~/private_keys
          # Ensure clean writing of the key
          printf "%s\n" "$KEY_CONTENT" > ~/private_keys/AuthKey_$CLEAN_KEY_ID.p8
          
          echo "Step 1: Testing Connection (altool)..."
          xcrun altool --list-providers \
            --apiKey "$CLEAN_KEY_ID" \
            --apiIssuer "$CLEAN_ISSUER_ID" || echo "altool check failed, continuing to check app-store-connect tool..."
          
          echo "Step 2: Uploading IPA..."
          # We use the most reliable path for the IPA
          IPA_FILE=$(find build/ios/ipa -name "*.ipa" | head -n 1)
          
          xcrun altool --upload-app --type ios \
            --file "$IPA_FILE" \
            --apiKey "$CLEAN_KEY_ID" \
            --apiIssuer "$CLEAN_ISSUER_ID" --verbose
            
      - name: Compress Simulator Build
        run: |
          cd ios_wrapper/build/ios/iphonesimulator
          zip -r HiruCalendar_Simulator.zip Runner.app
          
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: hiru-calendar-builds
          path: |
            ios_wrapper/build/ios/iphonesimulator/HiruCalendar_Simulator.zip
            ios_wrapper/build/ios/ipa/*.ipa
