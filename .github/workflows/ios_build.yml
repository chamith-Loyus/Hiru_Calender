name: Build iOS Wrapper

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          
      - name: Install dependencies
        run: |
          cd ios_wrapper
          flutter pub get
          
      - name: Build iOS (Simulator)
        run: |
          cd ios_wrapper
          flutter build ios --simulator --no-codesign
          
      - name: Build iOS (Production)
        if: github.repository == 'chamith-Loyus/Hiru_Calender'
        env:
          P12_BASE64: ${{ secrets.P12_CERTIFICATE }}
          P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
          PROVISIONING_BASE64: ${{ secrets.PROVISIONING_PROFILE }}
        run: |
          cd ios_wrapper
          mkdir -p ios/certs
          
          # Use base64 -D or openssl to ensure correct decoding on macOS
          echo "$P12_BASE64" | base64 -D -o ios/certs/certificate.p12
          echo "$PROVISIONING_BASE64" | base64 -D -o ios/certs/profile.mobileprovision
          
          # Verify file sizes (Diagnostic)
          ls -lh ios/certs/
          
          # Install Provisioning Profile
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp ios/certs/profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/
          
          # Create temporary keychain for signing
          security create-keychain -p "buildpass" build.keychain
          security list-keychains -s build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "buildpass" build.keychain
          
          # Import the certificate
          # Using -P (capital P) for the password
          security import ios/certs/certificate.p12 -k build.keychain -P "$P12_PASSWORD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "buildpass" build.keychain
          
          # Build signed IPA
          flutter build ipa --release --export-options-plist=ios/ExportOptions.plist
          
      - name: Upload to TestFlight
        if: github.repository == 'chamith-Loyus/Hiru_Calender'
        env:
          KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_KEY_CONTENT }}
        run: |
          cd ios_wrapper
          # Create the .p8 file for xcrun
          mkdir -p ~/.appstoreconnect/private_keys
          echo "$KEY_CONTENT" > ~/.appstoreconnect/private_keys/AuthKey_$KEY_ID.p8
          
          # Upload via xcrun altool or xcrun app-store-connect
          xcrun altool --upload-app --type ios \
            --file build/ios/ipa/*.ipa \
            --apiKey "$KEY_ID" --apiIssuer "$ISSUER_ID"
            
      - name: Compress Simulator Build
        run: |
          cd ios_wrapper/build/ios/iphonesimulator
          zip -r HiruCalendar_Simulator.zip Runner.app
          
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: hiru-calendar-builds
          path: |
            ios_wrapper/build/ios/iphonesimulator/HiruCalendar_Simulator.zip
            ios_wrapper/build/ios/ipa/*.ipa
