name: Build iOS Wrapper

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          
      - name: Install dependencies
        run: |
          cd ios_wrapper
          flutter pub get
          
      - name: Build iOS (Simulator)
        run: |
          cd ios_wrapper
          flutter build ios --simulator --no-codesign
          
      - name: Build iOS (Production)
        if: github.repository == 'chamith-Loyus/Hiru_Calender'
        env:
          P12_BASE64: ${{ secrets.P12_CERTIFICATE }}
          P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
          PROVISIONING_BASE64: ${{ secrets.PROVISIONING_PROFILE }}
          TEAM_ID: "6LQK8G38G5"
        run: |
          set -x
          cd ios_wrapper
          mkdir -p ios/certs
          
          # Decode certificates
          printf '%s' "$P12_BASE64" | base64 -D -o ios/certs/certificate.p12
          printf '%s' "$PROVISIONING_BASE64" | base64 -D -o ios/certs/profile.mobileprovision
          
          # Extract UUID from Provisioning Profile
          UUID=$(grep -aA1 "UUID" ios/certs/profile.mobileprovision | grep -o "[-A-Z0-9]\{36\}")
          echo "Profile UUID: $UUID"
          
          # Install Provisioning Profile using its UUID
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp ios/certs/profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/$UUID.mobileprovision
          
          # Create and setup temporary keychain
          security create-keychain -p "buildpass" build.keychain
          security list-keychains -d user -s build.keychain $(security list-keychains -d user | xargs)
          security default-keychain -s build.keychain
          security unlock-keychain -p "buildpass" build.keychain
          security set-keychain-settings -lut 21600 build.keychain
          
          # Import certificate
          security import ios/certs/certificate.p12 -k build.keychain -P "$P12_PASSWORD" -A
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "buildpass" build.keychain
          
          # Find the exact Identity Common Name
          echo "Listing all identities in keychain:"
          security find-identity -v -p codesigning build.keychain
          
          echo "Checking Certificates:"
          security find-certificate -a build.keychain
          
          IDENTITY=$(security find-identity -v -p codesigning build.keychain | grep "Apple Distribution" | head -n 1 | awk -F '"' '{print $2}')
          echo "Current Identity Variable: $IDENTITY"
          
          if [ -z "$IDENTITY" ]; then
            echo "ERROR: No Apple Distribution identity found in keychain!"
            exit 1
          fi
          
          # Build signed IPA
          flutter build ipa --release \
            --export-options-plist=ios/ExportOptions.plist \
            --build-name=1.0.0 --build-number=1 \
            --code-sign-identity="$IDENTITY" \
            --provisioning-profile-specifier="Hiru Calendar 2026 App Store" \
            --verbose

          
      - name: Upload to TestFlight
        if: github.repository == 'chamith-Loyus/Hiru_Calender'
        env:
          KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_KEY_CONTENT }}
        run: |
          cd ios_wrapper
          # Create the .p8 file for xcrun
          mkdir -p ~/.appstoreconnect/private_keys
          echo "$KEY_CONTENT" > ~/.appstoreconnect/private_keys/AuthKey_$KEY_ID.p8
          
          # Upload via xcrun altool or xcrun app-store-connect
          xcrun altool --upload-app --type ios \
            --file build/ios/ipa/*.ipa \
            --apiKey "$KEY_ID" --apiIssuer "$ISSUER_ID"
            
      - name: Compress Simulator Build
        run: |
          cd ios_wrapper/build/ios/iphonesimulator
          zip -r HiruCalendar_Simulator.zip Runner.app
          
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: hiru-calendar-builds
          path: |
            ios_wrapper/build/ios/iphonesimulator/HiruCalendar_Simulator.zip
            ios_wrapper/build/ios/ipa/*.ipa
